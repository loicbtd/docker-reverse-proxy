#!/bin/bash

DH_KEY_SIZE=1024

generate(){
    echo "NOTICE: Generating new Diffie-Hellman parameters file of $DH_KEY_SIZE bits. This may take a very long time. There will be another message once this process is completed"
    openssl dhparam -out /etc/nginx/ssl/dhparams.pem $DH_KEY_SIZE
    echo "NOTICE: DH parameters successfully created - $DH_KEY_SIZE bits"
}

main(){
    if [ ! -f /etc/nginx/ssl/dhparams.pem ]; then
        echo "WARNING: no DH parameters file found."
        generate
    else
        old_dh_key_size=$(openssl dhparam -in /etc/nginx/ssl/dhparams.pem -text -noout | grep "DH Parameters" | cut -d "(" -f2 | cut -d " " -f1)
        if [ "$old_dh_key_size" = "$DH_KEY_SIZE" ]; then
            echo "NOTICE: $DH_KEY_SIZE bit DH parameters present, skipping"
        else
            echo "WARNING: $old_dh_key_size bits DH parameters found, generating a new one with $DH_KEY_SIZE bits"
            rm /etc/nginx/ssl/dhparams.pem
            generate
        fi
    fi
}

main "$@"